# Azure Container Apps deployment configuration
# This file uses environment variables for all values
# Set the following variables before using:
#   AZURE_SUBSCRIPTION_ID, AZURE_RESOURCE_GROUP, LOCATION
#   ACR_NAME, IMAGE_NAME, IMAGE_TAG, ENVIRONMENT_NAME, IDENTITY_NAME
#   AZURE_API_KEY, APP_API_KEY, AZURE_ACCOUNT_NAME
#   AZURE_AI_FOUNDRY_ENDPOINT, AZURE_OPENAI_ENDPOINT, AZURE_AI_SERVICES_ENDPOINT
#   AZURE_SPEECH_TO_TEXT_ENDPOINT, GPT_TRANSCRIBE_MODEL, GPT_AUDIO_MODEL
apiVersion: 2023-05-01
location: ${LOCATION}
identity:
  type: SystemAssigned
properties:
  environmentId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.App/managedEnvironments/${ENVIRONMENT_NAME}
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: true
      targetPort: 3000
      transport: http
      allowInsecure: false
    secrets:
      - name: azure-api-key
        value: "${AZURE_API_KEY}"
      - name: app-api-key
        value: "${APP_API_KEY}"
    registries:
      - server: ${ACR_NAME}.azurecr.io
        identity: /subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${IDENTITY_NAME}
  template:
    containers:
      - name: video-transcribe-api
        image: ${ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}
        env:
          - name: AZURE_SUBSCRIPTION_ID
            value: "${AZURE_SUBSCRIPTION_ID}"
          - name: AZURE_RESOURCE_GROUP
            value: "${AZURE_RESOURCE_GROUP}"
          - name: AZURE_ACCOUNT_NAME
            value: "${AZURE_ACCOUNT_NAME}"
          - name: AZURE_API_KEY
            secretRef: azure-api-key
          - name: API_KEY
            secretRef: app-api-key
          - name: AZURE_AI_FOUNDRY_ENDPOINT
            value: "${AZURE_AI_FOUNDRY_ENDPOINT}"
          - name: AZURE_OPENAI_ENDPOINT
            value: "${AZURE_OPENAI_ENDPOINT}"
          - name: AZURE_AI_SERVICES_ENDPOINT
            value: "${AZURE_AI_SERVICES_ENDPOINT}"
          - name: AZURE_SPEECH_TO_TEXT_ENDPOINT
            value: "${AZURE_SPEECH_TO_TEXT_ENDPOINT}"
          - name: GPT_TRANSCRIBE_MODEL
            value: "${GPT_TRANSCRIBE_MODEL}"
          - name: GPT_AUDIO_MODEL
            value: "${GPT_AUDIO_MODEL}"
          - name: LOG_LEVEL
            value: "info"
        resources:
          cpu: 1
          memory: 2Gi
        probes:
          - type: liveness
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          - type: readiness
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
    scale:
      minReplicas: 1
      maxReplicas: 10
      rules:
        - name: http-rule
          http:
            metadata:
              concurrentRequests: "5"
